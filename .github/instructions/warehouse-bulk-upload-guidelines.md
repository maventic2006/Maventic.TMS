# TMS Warehouse Bulk Upload Guidelines

> **Comprehensive Bulk Upload Functionality Specifications for Warehouse Management**

This document establishes the detailed requirements, technical specifications, and implementation standards for the bulk upload functionality for warehouses in the TMS (Transportation Management System) project.

---

##  **FUNCTIONAL REQUIREMENTS**

### 1. Core Features

#### **Upload Functionality**

- **Location**: Warehouse Maintenance Create page (WarehouseCreatePage)
- **Access**: Product Owner, Admin, Consignor roles
- **Capacity**: Support for 500+ warehouses per upload batch
- **File Format**: Excel files (.xlsx, .xls) with relational structure (3 sheets)
- **Validation**: Same validation rules as manual warehouse creation
- **Document Handling**: Documents uploaded separately after bulk upload
- **Geofencing**: Multiple coordinate rows per warehouse
- **Status Workflow**: Bulk uploaded warehouses   Pending  User approves  Active

#### **Download Functionality**

- **Template Download**: Excel template with 3 sheets (Basic Info, Sub-Location Header, Sub-Location Item)
- **Error Report Download**: Failed validation rows with highlighted errors
- **Batch History**: Upload history with success/error details

### 2. User Interface Requirements

#### **Warehouse Create Page Integration**

- **Bulk Upload Button**: Add Bulk Upload button in top action bar
- **Modal Popup**: Dedicated modal with file picker
- **Progress Indicator**: Real-time upload progress
- **Batch History**: Track all upload batches
- **Processing**: Asynchronous background processing (Redis queue)

---

##  **EXCEL TEMPLATE STRUCTURE**

### **Relational Structure Approach**

The Excel file uses a **parent-child relational structure** where:
- Sheet 1: Warehouse Basic Information (parent records)
- Sheet 2: Warehouse Sub Location Header (child of warehouses)
- Sheet 3: Warehouse Sub Location Item (child of sub-location headers, contains coordinates)
- IDs are AUTO-GENERATED by the system
- Multiple child records can exist for one warehouse

### **Sheet 1: Warehouse Basic Information**

| Column | Field Name                    | Type    | Required | Format/Values           |
|--------|-------------------------------|---------|----------|-------------------------|
| A      | Warehouse_Unique_Id           | Text    | No       | AUTO-GENERATED          |
| B      | Warehouse_ID                  | Text    | No       | AUTO-GENERATED (WH001)  |
| C      | Consignor_ID                  | Text    | No       | AUTO-FILLED from user   |
| D      | Warehouse_Type                | Text    | Yes      | From master data        |
| E      | Warehouse_Name1               | Text    | Yes      | Max 30 chars, unique    |
| F      | Warehouse_Name2               | Text    | Yes      | Max 30 chars            |
| G      | Language                      | Text    | Yes      | Default: EN             |
| H      | Vehicle_Capacity              | Number  | Yes      | Min: 0                  |
| I      | Virtual_Yard_In               | Boolean | No       | TRUE/FALSE              |
| J      | Radius_Virtual_Yard_In        | Number  | No       | In KM (if Virtual=TRUE) |
| K      | Speed_Limit                   | Number  | Yes      | Default: 20 KM/H        |
| L      | Weigh_Bridge_Availability     | Boolean | No       | TRUE/FALSE              |
| M      | Gatepass_System_Available     | Boolean | No       | TRUE/FALSE              |
| N      | Fuel_Availability             | Boolean | No       | TRUE/FALSE              |
| O      | Staging_Area                  | Boolean | No       | TRUE/FALSE              |
| P      | Driver_Waiting_Area           | Boolean | No       | TRUE/FALSE              |
| Q      | Gate_In_Checklist_Auth        | Boolean | No       | TRUE/FALSE              |
| R      | Gate_Out_Checklist_Auth       | Boolean | No       | TRUE/FALSE              |
| S      | Country                       | Text    | Yes      | ISO Code (IN, US, etc.) |
| T      | State                         | Text    | Yes      | ISO Code (MH, CA, etc.) |
| U      | City                          | Text    | Yes      | City name               |
| V      | District                      | Text    | No       | District name           |
| W      | Street_1                      | Text    | Yes      | Street address line 1   |
| X      | Street_2                      | Text    | No       | Street address line 2   |
| Y      | Postal_Code                   | Text    | No       | Postal/ZIP code         |
| Z      | VAT_Number                    | Text    | Yes      | Must be unique          |
| AA     | TIN_PAN                       | Text    | No       | Tax ID, must be unique  |
| AB     | TAN                           | Text    | No       | TAN number, unique      |
| AC     | Address_Type                  | Text    | Yes      | From master data        |

**Notes:**
- Warehouse_Name1 must be unique across all warehouses
- VAT_Number must be unique
- TIN_PAN must be unique if provided
- TAN must be unique if provided

### **Sheet 2: Warehouse Sub Location Header**

| Column | Field Name          | Type | Required | Format/Values                |
|--------|---------------------|------|----------|------------------------------|
| A      | SubLocation_Hdr_Id  | Text | No       | AUTO-GENERATED (WSLH0001)    |
| B      | Warehouse_Name1     | Text | Yes      | Reference to Sheet 1 Column E|
| C      | Consignor_Id        | Text | No       | AUTO-FILLED from user        |
| D      | SubLocation_ID      | Text | No       | AUTO-GENERATED               |
| E      | Subtype_Name        | Text | Yes      | From master data             |
| F      | Description         | Text | No       | Description of sub-location  |

**Notes:**
- Warehouse_Name1 is used as a reference key (must exist in Sheet 1)
- Multiple sub-locations allowed per warehouse

### **Sheet 3: Warehouse Sub Location Item (Geofencing Coordinates)**

| Column | Field Name         | Type   | Required | Format/Values                |
|--------|--------------------|--------|----------|------------------------------|
| A      | GeoFence_Item_Id   | Text   | No       | AUTO-GENERATED               |
| B      | Warehouse_Name1    | Text   | Yes      | Reference to Sheet 1 Column E|
| C      | Subtype_Name       | Text   | Yes      | Reference to Sheet 2 Column E|
| D      | Sequence           | Number | Yes      | Order of coordinates (1,2,3.)|
| E      | Latitude           | Decimal| Yes      | GPS latitude (-90 to 90)     |
| F      | Longitude          | Decimal| Yes      | GPS longitude (-180 to 180)  |

**Notes:**
- Minimum 3 coordinates required per sub-location (to form a polygon)
- Sequence must be continuous (1, 2, 3, 4...)
- Coordinates define the geofencing boundary

---

##  **VALIDATION RULES**

### **Sheet 1: Warehouse Basic Information**

1. **Warehouse_Name1**: 
   - Required
   - Max 30 characters
   - Must be unique across all warehouses (including existing)

2. **Warehouse_Name2**:
   - Required
   - Max 30 characters

3. **Warehouse_Type**:
   - Required
   - Must exist in warehouse_type_master table

4. **VAT_Number**:
   - Required
   - Must be unique across all warehouses

5. **TIN_PAN**:
   - Optional
   - Must be unique if provided

6. **TAN**:
   - Optional
   - Must be unique if provided

7. **Vehicle_Capacity**:
   - Required
   - Must be >= 0

8. **Speed_Limit**:
   - Required
   - Default: 20
   - Must be >= 1 and <= 200

9. **Country, State, City**:
   - All required
   - Must be valid ISO codes

### **Sheet 2: Sub-Location Header**

1. **Warehouse_Name1**:
   - Required
   - Must exist in Sheet 1

2. **Subtype_Name**:
   - Required
   - Must exist in warehouse_sub_location_master table

### **Sheet 3: Sub-Location Item**

1. **Warehouse_Name1**:
   - Required
   - Must exist in Sheet 1

2. **Subtype_Name**:
   - Required
   - Must exist in Sheet 2 for the same warehouse

3. **Sequence**:
   - Required
   - Must be continuous (1, 2, 3, 4...)

4. **Latitude/Longitude**:
   - Required
   - Valid GPS coordinates
   - Latitude: -90 to 90
   - Longitude: -180 to 180

5. **Minimum Coordinates**:
   - At least 3 coordinates per sub-location

---

##  **PROCESSING WORKFLOW**

### **Upload Process**

1. **File Upload**:
   - User selects Excel file
   - Frontend validates file type (.xlsx, .xls)
   - File sent to backend API

2. **Backend Processing**:
   - File parsed using ExcelJS
   - Read all 3 sheets
   - Validate structure (columns, headers)

3. **Data Validation**:
   - Validate each row in Sheet 1
   - Check duplicates (Warehouse Name, VAT, TIN/PAN, TAN)
   - Validate master data references
   - Validate Sheet 2 references
   - Validate Sheet 3 coordinates (min 3 per sub-location)

4. **Database Transaction**:
   - Create warehouse records (status: PENDING)
   - Create address records
   - Create sub-location headers
   - Create sub-location items (coordinates)
   - All within a single transaction (rollback on error)

5. **Error Handling**:
   - If validation fails: Generate error Excel with highlighted issues
   - If success: Create warehouses in PENDING status
   - Partial success: Create valid warehouses, return error report for failed ones

6. **Status Update**:
   - Upload batch saved to database
   - Status: processing  completed or failed
   - User can download error report if failures exist

---

##  **SUCCESS CRITERIA**

-  Template download works with all 3 sheets
-  Excel parsing handles 500+ warehouses
-  Validation catches duplicates (name, VAT, TIN/PAN, TAN)
-  Geofencing coordinates properly linked
-  Error report shows specific validation errors
-  Warehouses created in PENDING status
-  Redis job queue handles async processing
-  No database corruption on partial failure

---

##  **API ENDPOINTS**

### **POST /api/warehouse/bulk-upload**
- **Description**: Upload Excel file for bulk warehouse creation
- **Auth**: Required (Product Owner, Admin, Consignor)
- **Body**: multipart/form-data with Excel file
- **Response**: 
  `json
  {
    success: true,
    data: {
      batchId: BATCH001,
      status: processing,
      totalRecords: 50,
      message: Upload initiated. Processing in background.
    }
  }
  `

### **GET /api/warehouse/bulk-upload/template**
- **Description**: Download Excel template with 3 sheets
- **Auth**: Required
- **Response**: Excel file download

### **GET /api/warehouse/bulk-upload/batch/:batchId**
- **Description**: Check batch upload status
- **Auth**: Required
- **Response**:
  `json
  {
    success: true,
    data: {
      batchId: BATCH001,
      status: completed,
      totalRecords: 50,
      successCount: 48,
      errorCount: 2,
      errors: [...]
    }
  }
  `

### **GET /api/warehouse/bulk-upload/errors/:batchId**
- **Description**: Download error report Excel
- **Auth**: Required
- **Response**: Excel file with errors

---

##  **IMPLEMENTATION FILES**

1. **Frontend**:
   - WarehouseBulkUploadModal.jsx - Modal component
   - warehouseSlice.js - Redux actions (uploadWarehouseBulk, downloadWarehouseTemplate, etc.)

2. **Backend**:
   - outes/warehouse.js - Bulk upload routes
   - controllers/warehouseController.js - Bulk upload controller
   - services/warehouseBulkUploadService.js - Excel parsing and validation logic
   - jobs/warehouseBulkUploadJob.js - Redis Bull queue job

3. **Database**:
   - warehouse_bulk_upload_batches table for tracking uploads

---

##  **TESTING CHECKLIST**

- [ ] Template download includes all 3 sheets with correct columns
- [ ] Upload validates file type (.xlsx, .xls only)
- [ ] Duplicate warehouse name detected
- [ ] Duplicate VAT number detected
- [ ] Duplicate TIN/PAN detected
- [ ] Duplicate TAN detected
- [ ] Invalid warehouse type rejected
- [ ] Missing required fields detected
- [ ] Sheet 2 references validated
- [ ] Sheet 3 minimum 3 coordinates enforced
- [ ] Error Excel highlights specific issues
- [ ] Warehouses created in PENDING status
- [ ] Redis job queue processes batches
- [ ] Batch status polling works
- [ ] Error report download works

