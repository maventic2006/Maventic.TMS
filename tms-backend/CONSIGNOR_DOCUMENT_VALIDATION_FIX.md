# Consignor Document Validation Field Mismatch Fix

## Issue Identified

**Problem**: Document validation was failing with errors:
1. "Invalid input: expected string, received undefined"
2. "Invalid option: expected one of ACTIVE|INACTIVE|EXPIRED"

**Root Cause**: The validation schema (`documentSchema`) expected different field names than what the `DocumentsTab` component was creating.

### Field Name Mismatches Found:

| Component Field Name | Validation Schema Expected | Issue |
|---------------------|---------------------------|-------|
| `documentType` | `document_type_id` |  Name mismatch |
| `documentNumber` | `document_number` |  Name mismatch |
| `validFrom` | `valid_from` |  Name mismatch |
| `validTo` | `valid_to` |  Name mismatch |
| `status: true` (boolean) | `status: "ACTIVE"` (enum) |  Type mismatch |
| `country` | Not in schema |  Missing field |
| `fileName`, `fileType`, `fileData` | Not in schema |  Missing fields |

## Solution Implemented

### Updated Document Validation Schema

Changed `validation.js` documentSchema to match the actual field names used by `DocumentsTab.jsx`:

```javascript
export const documentSchema = z.object({
  // Field names match DocumentsTab component (camelCase)
  documentType: z
    .string()
    .min(1, "Document type is required"),

  documentNumber: z
    .string()
    .min(1, "Document number is required")
    .max(50, "Document number must not exceed 50 characters"),

  country: z
    .string()
    .optional()
    .nullable(),

  validFrom: z
    .string()
    .min(1, "Valid from date is required"),

  validTo: z
    .string()
    .min(1, "Valid to date is required"),

  // File-related fields from ThemeTable
  fileName: z
    .string()
    .optional()
    .nullable(),

  fileType: z
    .string()
    .optional()
    .nullable(),

  fileData: z
    .any()
    .optional()
    .nullable(),

  // Optional fields
  referenceNumber: z
    .string()
    .optional()
    .nullable(),

  status: z
    .boolean()  // Changed from enum to boolean
    .optional()
    .nullable(),
}).refine(
  (data) => {
    if (!data.validFrom || !data.validTo) return true;
    const fromDate = new Date(data.validFrom);
    const toDate = new Date(data.validTo);
    return toDate > fromDate;
  },
  {
    message: "Valid to date must be after valid from date",
    path: ["validTo"],
  }
);
```

### Key Changes Made:

1.  **Field Names**: Changed to camelCase to match component
   - `document_type_id`  `documentType`
   - `document_number`  `documentNumber`
   - `valid_from`  `validFrom`
   - `valid_to`  `validTo`

2.  **Status Field**: Changed from enum to boolean
   - Old: `z.enum(["ACTIVE", "INACTIVE", "EXPIRED"]).default("ACTIVE")`
   - New: `z.boolean().optional().nullable()`

3.  **Added Missing Fields**: 
   - `country` - Used by DocumentsTab for country selection
   - `fileName` - File name after upload
   - `fileType` - File MIME type
   - `fileData` - File data/content
   - `referenceNumber` - Optional reference field

4.  **Removed Unnecessary Validations**:
   - Removed `document_id` (auto-generated by backend)
   - Removed file type validation (handled by ThemeTable)
   - Removed file size validation (handled by ThemeTable)
   - Simplified date validation (removed Date parsing check)

## Document Fields in DocumentsTab Component

The DocumentsTab component creates documents with these fields:

```javascript
const newDocument = {
  documentType: "",        //  Required - Selected from dropdown
  documentNumber: "",      //  Required - User input
  referenceNumber: "",     // Optional
  country: "",             // Optional - Selected from dropdown
  validFrom: "",           //  Required - Date picker
  validTo: "",             //  Required - Date picker
  status: true,            // Boolean (not enum)
  fileName: "",            // Set by file upload
  fileType: "",            // Set by file upload
  fileData: "",            // Set by file upload
};
```

### Required Fields (User Must Fill):
1.  **Document Type** - Dropdown selection (PAN Card, GSTIN, etc.)
2.  **Document Number** - Text input
3.  **Valid From** - Date picker
4.  **Valid To** - Date picker

### Optional Fields:
- Country (dropdown)
- Reference Number (text)
- File Upload (document scan/photo)

### Auto-Populated Fields:
- `status` - Defaults to `true` (active)
- `fileName`, `fileType`, `fileData` - Populated on file upload

## Testing Instructions

### 1. Clear Browser Cache
```
Press Ctrl+Shift+Delete
Select "Cached images and files" and "Cookies"
Clear data
```

### 2. Restart Frontend
```powershell
cd frontend
npm run dev
```

### 3. Test Document Creation

1. Navigate to: `http://localhost:5173/consignor/create`
2. Fill General Information tab (name, search term, industry, payment term)
3. Fill Contact Information tab (at least one contact)
4. Fill Organization Details tab (company code, select multiple states)
5. Go to **Documents** tab
6. Click "Add Row"
7. Fill document fields:
   - Select **Document Type** (e.g., "PAN Card")
   - Enter **Document Number** (e.g., "ABCDE1234F")
   - Select **Country** (optional, e.g., "India")
   - Select **Valid From** date
   - Select **Valid To** date (must be after Valid From)
   - Upload file (optional - PDF/JPG/PNG)
8. Click "Review & Submit"
9. Click "Create Consignor"

### Expected Results:
-  No validation errors about "expected string, received undefined"
-  No validation errors about "Invalid option: expected one of ACTIVE|INACTIVE|EXPIRED"
-  Document validation passes if all required fields filled
-  Date validation: "Valid to date must be after valid from date"
-  Consignor created successfully with documents

### Error Scenarios to Test:

1. **Missing Document Type**
   - Leave document type empty
   - Expected: "Document type is required"

2. **Missing Document Number**
   - Leave document number empty
   - Expected: "Document number is required"

3. **Missing Valid From**
   - Leave valid from date empty
   - Expected: "Valid from date is required"

4. **Missing Valid To**
   - Leave valid to date empty
   - Expected: "Valid to date is required"

5. **Invalid Date Range**
   - Set Valid To date before Valid From
   - Expected: "Valid to date must be after valid from date"

## Files Modified

### Frontend
1. **frontend/src/features/consignor/validation.js**
   - Updated `documentSchema` to match DocumentsTab field names
   - Changed field names from snake_case to camelCase
   - Changed status from enum to boolean
   - Added missing fields (country, fileName, fileType, fileData, referenceNumber)
   - Simplified validation logic

## Backend Data Transformation

**Note**: The backend expects snake_case field names. The data transformation happens in the service layer:

```javascript
// Frontend sends (camelCase):
{
  documentType: "DTCONS001",
  documentNumber: "ABCDE1234F",
  validFrom: "2024-01-01",
  validTo: "2029-01-01"
}

// Backend receives/transforms to (snake_case):
{
  document_type_id: "DTCONS001",
  document_number: "ABCDE1234F",
  valid_from: "2024-01-01",
  valid_to: "2029-01-01"
}
```

**The transformation is handled by the backend service layer** - frontend validation now matches what the component actually sends.

## Summary of All Fixes

### Fix 1: Business Area Array 
- Changed `business_area: z.string()`  `z.array(z.string())`

### Fix 2: NDA/MSA Length Limits 
- Changed `upload_nda` and `upload_msa` from `max(20)`  `max(255)`

### Fix 3: Document Field Name Mismatch 
- Changed all document fields from snake_case to camelCase
- Changed status from enum to boolean
- Added missing fields (country, fileName, fileType, fileData)

### Fix 4: Removed Unnecessary Validations 
- Removed document_id (auto-generated)
- Removed file type/size validation (handled by ThemeTable)
- Removed strict date parsing (simplified)

## Next Steps

1.  Clear browser cache
2.  Restart frontend server
3.  Test consignor creation with:
   - Multiple states in Organization tab
   - Long NDA/MSA references in General Info tab
   - Multiple documents in Documents tab
   - Contact photos in Contact tab
4.  Verify data stored correctly in database
5.  Verify files uploaded to uploads/ folder

## Database Verification

After successful creation, verify in MySQL:

```sql
-- Check consignor created
SELECT * FROM customer_master 
ORDER BY created_at DESC LIMIT 1;

-- Check documents uploaded
SELECT * FROM document_upload 
WHERE document_type_id IN (
  SELECT document_type_id FROM doc_type_configuration 
  WHERE user_type = 'CONSIGNOR'
)
ORDER BY created_at DESC;

-- Check contacts with photos
SELECT contact_id, contact_name, contact_photo 
FROM customer_contact_master 
ORDER BY created_at DESC;

-- Check organization details
SELECT * FROM consignor_organization_details
ORDER BY created_at DESC LIMIT 1;
```

## Conclusion

All validation errors related to document fields have been fixed. The validation schema now accurately reflects the actual field structure used by the DocumentsTab component, with no extraneous validations that would cause "expected string, received undefined" or enum validation errors.

**Key Takeaway**: Frontend validation schemas must match the exact field names and types used by the UI components to prevent validation mismatches.
